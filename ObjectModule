

Функция ОсновнаяРабота(аргСтрукАргументы) Экспорт
	
    ТабзначРезультат = Новый ТаблицаЗначений;
	
	Если аргСтрукАргументы.перКоманда = 1 Тогда 
		
		стрXml = ЗапроситьПоВебАдресу("cbr.ru", СделатьЗапросКотировок(аргСтрукАргументы.стрДеньНачала, аргСтрукАргументы.стрМесяцНачала, 
		аргСтрукАргументы.стрГодНачала));
		стрXml = ПроверитьXML(стрXml, "cursNamespace", "ValCurs", Истина);
		
		обОписаниеКонтейнерКурсовВалют = ФабрикаXDTO.Пакеты.Получить("cursNamespace");
		обОписаниеКонтеинераКурса = обОписаниеКонтейнерКурсовВалют.КорневыеСвойства.Получить("ValCurs");
		
		обКонтейнерВалютныхКурсов = СоздатьXdtoИзXml(стрXml, обОписаниеКонтеинераКурса.Тип);
		
		Если Не обКонтейнерВалютныхКурсов.Свойства().Получить("Valute") = Неопределено Тогда
			ТабзначРезультат = ЗаписатьСписокXdtoВТаблицу(обКонтейнерВалютныхКурсов["Valute"], СоздатьМассивКолонокКурсовВалют());
		КонецЕсли;
		
	ИначеЕсли аргСтрукАргументы.перКоманда = 2 Тогда
		
		стрXml = ЗапроситьПоВебАдресу("cbr.ru", СделатьЗапросКодовВалют());
		стрXml = ПроверитьXML(стрXml, "valutaNamespace", "Valuta", Истина);
		
		обОписаниеКонтейнерВалют = ФабрикаXDTO.Пакеты.Получить("valutaNamespace");
		обОписаниеКонтейнерВалюты = обОписаниеКонтейнерВалют.КорневыеСвойства.Получить("Valuta");
		
		обКонтейнерВалют = СоздатьXdtoИзXml(стрXml, обОписаниеКонтейнерВалюты.Тип);
		
		Если Не обКонтейнерВалют.Свойства().Получить("Item") = Неопределено Тогда
			ТабзначРезультат = ЗаписатьСписокXdtoВТаблицу(обКонтейнерВалют["Item"], СоздатьМассивКолонокСправочниковВалют());
		КонецЕсли;
		
	ИначеЕсли аргСтрукАргументы.перКоманда = 3 Тогда
		
		стрXml = ЗапроситьПоВебАдресу("cbr.ru", СделатьЗапросДинамикиКурсаДоллара(аргСтрукАргументы.стрДеньНачала, 
		аргСтрукАргументы.стрМесяцНачала, аргСтрукАргументы.стрГодНачала, аргСтрукАргументы.стрДеньКонца, 
		аргСтрукАргументы.стрМесяцКонца, аргСтрукАргументы.стрГодКонца,  "R01235"));
		стрXml = ПроверитьXML(стрXml, "cursWithDynamicsNamespace", "ValCurs", Истина);
		
		обОписаниеКонтейнерКурсовВалют = ФабрикаXDTO.Пакеты.Получить("cursWithDynamicsNamespace");
		обОписаниеКонтеинераКурса = обОписаниеКонтейнерКурсовВалют.КорневыеСвойства.Получить("ValCurs");
		
		обКонтейнерВалютныхКурсов = СоздатьXdtoИзXml(стрXml, обОписаниеКонтеинераКурса.Тип);
		
		Если Не обКонтейнерВалютныхКурсов.Свойства().Получить("Record") = Неопределено Тогда
			ТабзначРезультат = ЗаписатьСписокXdtoВТаблицу(обКонтейнерВалютныхКурсов["Record"], СоздатьМассивКолонокДинамикиВалют());
		КонецЕсли;
		
	ИначеЕсли аргСтрукАргументы.перКоманда = 4 Тогда
		
		стрXml = ЗапроситьПоВебАдресу("cbr.ru", СделатьЗапросОстатковСредствКредитныхОрганизаций(аргСтрукАргументы.стрДеньНачала, 
		аргСтрукАргументы.стрМесяцНачала, аргСтрукАргументы.стрГодНачала, аргСтрукАргументы.стрДеньКонца, 
		аргСтрукАргументы.стрМесяцКонца, аргСтрукАргументы.стрГодКонца));
		
		обКонтейнерОстатковСредствКредитныхОрганизаций = СоздатьXdtoИзXml(стрXml);
		
		Если Не обКонтейнерОстатковСредствКредитныхОрганизаций.Свойства().Получить("Record") = Неопределено Тогда
			ТабзначРезультат = ЗаписатьСписокXdtoВТаблицу(обКонтейнерОстатковСредствКредитныхОрганизаций["Record"] , 
			СоздатьМассивКолонокОстатковСредствКредитныхОрганизаций());
		КонецЕсли;
		
	ИначеЕсли аргСтрукАргументы.перКоманда = 5 Тогда
		
		стрXml = ЗапроситьПоВебАдресу("cbr.ru", СделатьЗапросКотировокДрагМеталлов(аргСтрукАргументы.стрДеньНачала, 
		аргСтрукАргументы.стрМесяцНачала, аргСтрукАргументы.стрГодНачала, аргСтрукАргументы.стрДеньКонца, 
		аргСтрукАргументы.стрМесяцКонца, аргСтрукАргументы.стрГодКонца));
		
		обКонтейнерКотировокДрагоценныхМеталлов = СоздатьXdtoИзXml(стрXml);
		
		Если Не обКонтейнерКотировокДрагоценныхМеталлов.Свойства().Получить("Record") = Неопределено Тогда
			ТабзначРезультат = ЗаписатьСписокXdtoВТаблицу(обКонтейнерКотировокДрагоценныхМеталлов["Record"], 
			СоздатьМассивКолонокКотировокДрагценныхМеталлов());
		КонецЕсли;
		
	ИначеЕсли аргСтрукАргументы.перКоманда = 6 Тогда
		
		стрXml = ЗапроситьПоВебАдресу("cbr.ru", СделатьЗапросДинамикиСтавокМежбанковскогоРынка(аргСтрукАргументы.стрДеньНачала, 
		аргСтрукАргументы.стрМесяцНачала, аргСтрукАргументы.стрГодНачала, аргСтрукАргументы.стрДеньКонца, 
		аргСтрукАргументы.стрМесяцКонца, аргСтрукАргументы.стрГодКонца));
		
		обКонтейнерДинамикиСтавокМежбанковскогоРынка = СоздатьXdtoИзXml(стрXml);

		Если Не обКонтейнерДинамикиСтавокМежбанковскогоРынка.Свойства().Получить("Record") = Неопределено Тогда
			ТабзначРезультат = ЗаписатьСписокXdtoВТаблицу(обКонтейнерДинамикиСтавокМежбанковскогоРынка["Record"], 
			СоздатьМассивКолонокДинамикиСтавокМежбанковскогоРынка());
		КонецЕсли;
		
	ИначеЕсли аргСтрукАргументы.перКоманда = 7 Тогда
		
		стрXml = ЗапроситьПоВебАдресу("cbr.ru", СделатьЗапросДинамикиСтавокПривлеченияСредств(аргСтрукАргументы.стрДеньНачала, 
		аргСтрукАргументы.стрМесяцНачала, аргСтрукАргументы.стрГодНачала, аргСтрукАргументы.стрДеньКонца, 
		аргСтрукАргументы.стрМесяцКонца, аргСтрукАргументы.стрГодКонца));
		
		обКонтейнерДинамикиСтавокПривлеченияСредств = СоздатьXdtoИзXml(стрXml);
		
		Если Не обКонтейнерДинамикиСтавокПривлеченияСредств.Свойства().Получить("Record") = Неопределено Тогда
			ТабзначРезультат = ЗаписатьСписокXdtoВТаблицу(обКонтейнерДинамикиСтавокПривлеченияСредств["Record"], 
			СоздатьМассивКолонокДинамикиСтавокПривлеченияСредств());
		КонецЕсли;
		
	ИначеЕсли аргСтрукАргументы.перКоманда = 8 Тогда
		
		стрXml = ЗапроситьПоВебАдресу("cbr.ru", СделатьЗапросПолученияНовостейСервера());		
		обКонтейнерНовостей = СоздатьXdtoИзXml(стрXml);
		
		Если Не обКонтейнерНовостей.Свойства().Получить("Item") = Неопределено Тогда
			ТабзначРезультат = ЗаписатьСписокXdtoВТаблицу(обКонтейнерНовостей["Item"], СоздатьМассивКолонокНовостей());
		КонецЕсли
		
	ИначеЕсли аргСтрукАргументы.перКоманда = 9 Тогда
		
		стрXml = ЗапроситьПоВебАдресу("cbr.ru", СделатьЗапросСоответствияBic("АВТО", "044525774"));		
		обКонтейнерНовостей = СоздатьXdtoИзXml(стрXml);
		
		Если Не обКонтейнерНовостей.Свойства().Получить("Item") = Неопределено Тогда
			ТабзначРезультат = ЗаписатьСписокXdtoВТаблицу(обКонтейнерНовостей["Item"], СоздатьМассивКолонокСоответствияBic());
		КонецЕсли 
		
	ИначеЕсли аргСтрукАргументы.перКоманда = 10 Тогда
		
		стрXml = ЗапроситьПоВебАдресу("cbr.ru", СделатьЗапросДинамикиСтавокВалютныйСвоп(аргСтрукАргументы.стрДеньНачала, 
		аргСтрукАргументы.стрМесяцНачала, аргСтрукАргументы.стрГодНачала, аргСтрукАргументы.стрДеньКонца, 
		аргСтрукАргументы.стрМесяцКонца, аргСтрукАргументы.стрГодКонца));		
		обКонтейнерДинамикиСтавокВалютныйСвоп = СоздатьXdtoИзXml(стрXml);
		
		Если Не обКонтейнерДинамикиСтавокВалютныйСвоп.Свойства().Получить("Record") = Неопределено Тогда
			ТабзначРезультат = ЗаписатьСписокXdtoВТаблицу(обКонтейнерДинамикиСтавокВалютныйСвоп["Record"], 
			СоздатьМассивКолонокДинамикиСтавокВалютныйСвоп());
		КонецЕсли
		
		ИначеЕсли аргСтрукАргументы.перКоманда = 11 Тогда
		
			стрXml = ЗапроситьПоВебАдресу("cbr.ru", СделатьЗапросДинамикиЦенНаИнвестиционныеМонеты(аргСтрукАргументы.стрДеньНачала, 
			аргСтрукАргументы.стрМесяцНачала, аргСтрукАргументы.стрГодНачала, аргСтрукАргументы.стрДеньКонца, 
			аргСтрукАргументы.стрМесяцКонца, аргСтрукАргументы.стрГодКонца));
			обКонтейнерДинамикиЦенНаИнвестиционныеМонеты = СоздатьXdtoИзXml(стрXml);
			
			Если Не обКонтейнерДинамикиЦенНаИнвестиционныеМонеты.Свойства().Получить("Record") = Неопределено Тогда
				ТабзначРезультат = ЗаписатьСписокXdtoВТаблицу(обКонтейнерДинамикиЦенНаИнвестиционныеМонеты["Record"], 
				СоздатьМассивКолонокобКонтейнерДинамикиЦенНаИнвестиционныеМонеты());
			КонецЕсли  
			
		ИначеЕсли аргСтрукАргументы.перКоманда = 12 Тогда
			
			стрXml = ЗапроситьПоВебАдресу("cbr.ru", СделатьЗапросОрганизацииСНелегальнойДеятельностью());	
			стрXml = ПроверитьXML(стрXml, "illegalCompaniezNamespace", "BlackList", Ложь);
			
			обОписаниеКонвертНелегальныхКомпаний = ФабрикаXDTO.Пакеты.Получить("illegalCompaniezNamespace");
            обОписаниеКонвертаНелегальнойКомпании = обОписаниеКонвертНелегальныхКомпаний.КорневыеСвойства.Получить("BlackList");
			
			обКонтейнерОрганизацииСНелегальнойДеятельностью = СоздатьXdtoИзXml(стрXml, обОписаниеКонвертаНелегальнойКомпании.Тип);
			
					
			Если Не обКонтейнерОрганизацииСНелегальнойДеятельностью.Свойства().Получить("RC") = Неопределено Тогда
				ТабзначРезультат = ЗаписатьСписокXdtoВТаблицу(обКонтейнерОрганизацииСНелегальнойДеятельностью["RC"], 
				СоздатьМассивКолонокНелегальныеОрганизации());
			КонецЕсли
		
	КонецЕсли;
	
	Возврат ТабзначРезультат;
	                     
КонецФункции




 Функция ЗапроситьПоВебАдресу(аргСтрАдрес, аргСтрДополнительныйАдрес)
	
	ВебСоединение = Новый HTTPСоединение(аргСтрАдрес);
	
	ВебЗапрос = Новый HTTPЗапрос(аргСтрДополнительныйАдрес);
	
	Результат = ВебСоединение.Получить(ВебЗапрос);
	
	стрТело = Результат.ПолучитьТелоКакСтроку();
	
	Возврат стрТело;
	
КонецФункции


Функция СделатьЗапросКотировок(аргСтрДень, аргСтрМесяц, аргСтрГод)
	Возврат "/scripts/XML_daily.asp?date_req=" + аргСтрДень + "/" + аргСтрМесяц + "/" + аргСтрГод;	
КонецФункции

Функция СделатьЗапросКодовВалют()
	Возврат "/scripts/XML_val.asp?d=0";	
КонецФункции

Функция СделатьЗапросДинамикиКурсаДоллара(аргСтрНачДень, аргСтрНачМесяц, аргСтрНачГод, аргСтрКонДень, аргСтрКонМесяц, аргСтрКонГод, 
	аргПерИдентификаторВалюты)
	Возврат "/scripts/XML_dynamic.asp?date_req1="+ аргСтрНачДень + "/" + аргСтрНачМесяц + "/" + аргСтрНачГод + "&date_req2="+ 
	аргСтрКонДень + "/" + аргСтрКонМесяц + "/" + аргСтрКонГод + "&VAL_NM_RQ=" + аргПерИдентификаторВалюты; 
КонецФункции

Функция СделатьЗапросОстатковСредствКредитныхОрганизаций(аргСтрНачДень, аргСтрНачМесяц, аргСтрНачГод, аргСтрКонДень, аргСтрКонМесяц, 
	аргСтрКонГод)	
	Возврат "/scripts/XML_ostat.asp?date_req1=" + аргСтрНачДень + "/" + аргСтрНачМесяц + "/" + аргСтрНачГод + "&date_req2=" + аргСтрКонДень + "/" + 
	аргСтрКонМесяц +"/"+ аргСтрКонГод;	
КонецФункции

Функция СделатьЗапросКотировокДрагМеталлов(аргСтрНачДень, аргСтрНачМесяц, аргСтрНачГод, аргСтрКонДень, аргСтрКонМесяц, аргСтрКонГод)
	Возврат "/scripts/xml_metall.asp?date_req1=" + аргСтрНачДень + "/" + аргСтрНачМесяц + "/" + аргСтрНачГод + "1&date_req2=" + аргСтрКонДень + 
	"/" + аргСтрКонМесяц + "/" + аргСтрКонГод; 
КонецФункции

Функция СделатьЗапросДинамикиСтавокМежбанковскогоРынка(аргСтрНачДень, аргСтрНачМесяц, аргСтрНачГод, аргСтрКонДень, аргСтрКонМесяц, аргСтрКонГод)
	Возврат "/scripts/xml_mkr.asp?date_req1=" + аргСтрНачДень + "/" + аргСтрНачМесяц + "/" + аргСтрНачГод + "&date_req2=" + аргСтрКонДень + "/" + 
	аргСтрКонМесяц + "/" + аргСтрКонГод; 
	КонецФункции

Функция СделатьЗапросДинамикиСтавокПривлеченияСредств(аргСтрНачДень, аргСтрНачМесяц, аргСтрНачГод, аргСтрКонДень, аргСтрКонМесяц, аргСтрКонГод)
	Возврат "/scripts/xml_depo.asp?date_req1=" + аргСтрНачДень + "/" + аргСтрНачМесяц + "/" + аргСтрНачГод + "&date_req2=" + аргСтрКонДень + 
	"/" + аргСтрКонМесяц + "/" + аргСтрКонГод;
КонецФункции

Функция СделатьЗапросПолученияНовостейСервера()
	 Возврат "/scripts/XML_News.asp";
КонецФункции

Функция СделатьЗапросСоответствияBic(аргСтрКредитнаяОрганизация, аргСтрКодКредитнойОрганизации) 
	Возврат "/scripts/XML_bic.asp?name="+ аргСтрКредитнаяОрганизация + "&bic=" + аргСтрКодКредитнойОрганизации;
КонецФункции                       

Функция СделатьЗапросДинамикиСтавокВалютныйСвоп(аргСтрНачДень, аргСтрНачМесяц, аргСтрНачГод, аргСтрКонДень, аргСтрКонМесяц, аргСтрКонГод)
	Возврат "/scripts/xml_swap.asp?date_req1=" + аргСтрНачДень + "/" + аргСтрНачМесяц + "/" + аргСтрНачГод + "&date_req2=" + аргСтрКонДень + "/" + 
	аргСтрКонМесяц + "/" + аргСтрКонГод;
КонецФункции

Функция СделатьЗапросДинамикиЦенНаИнвестиционныеМонеты(аргСтрНачДень, аргСтрНачМесяц, аргСтрНачГод, аргСтрКонДень, аргСтрКонМесяц, аргСтрКонГод)
	Возврат "/scripts/XMLCoinsBase.asp?date_req1=" + аргСтрНачДень + "/" + аргСтрНачМесяц + "/" + аргСтрНачГод + "&date_req2=" + 
	аргСтрКонДень + "/" + аргСтрКонМесяц + "/" + аргСтрКонГод;
КонецФункции

Функция СделатьЗапросОрганизацииСНелегальнойДеятельностью()
	Возврат "/Queries/FileSource/123124/BlackList.xml"
КонецФункции


Функция ПроверитьXML(аргСтрXML, аргСтрUri, аргСтрМестоВставки, аргФлИскатьСПробелом)  
	
	стрИсправленныйXml = аргСтрXML;
	
	стрПробел = " ";
	
	Если Не аргФлИскатьСПробелом Тогда
		стрПробел = "";
	КонецЕсли;
	
	Если Найти(аргСтрXML, "xmlns=") < 1 Тогда
		
		 индексВставки = Найти(аргСтрXML, аргСтрМестоВставки + стрПробел) + стрДлина(аргСтрМестоВставки + стрПробел) - 1;
		 
		 стрИсправленныйXml = Лев(аргСтрXML, индексВставки) + " xmlns=""" + аргСтрUri + """ " + Прав(аргСтрXML, стрДлина(аргСтрXML) - индексВставки);
		
	КонецЕсли;
	
		
	Возврат стрИсправленныйXml; 
	
КонецФункции


Функция СоздатьXdtoИзXml(аргСтрXml, аргОбТип = Неопределено)
	
	обЧитатель = Новый ЧтениеXML;
	обЧитатель.УстановитьСтроку(аргСтрXml);
	
	Если Не аргОбТип = Неопределено Тогда
		Возврат ФабрикаXDTO.ПрочитатьXML(обЧитатель, аргОбТип);  
	КонецЕсли; 
	
	Возврат ФабрикаXDTO.ПрочитатьXML(обЧитатель);
	
КонецФункции


Функция СоздатьМассивКолонокКурсовВалют()
	
	масРезультат = Новый Массив; 
	
	масРезультат.Добавить("ID");
	масРезультат.Добавить("Name");
	масРезультат.Добавить("Value");
	масРезультат.Добавить("Nominal");
	масРезультат.Добавить("NumCode");
	масРезультат.Добавить("CharCode");
	масРезультат.Добавить("VunitRate");
	
	Возврат масРезультат;
	
КонецФункции

Функция СоздатьМассивКолонокСправочниковВалют()
	
	масРезультат = Новый Массив; 
	
	масРезультат.Добавить("ID");
	масРезультат.Добавить("Name");
	масРезультат.Добавить("EngName");
	масРезультат.Добавить("Nominal");
	масРезультат.Добавить("ParentCode");
	
	Возврат масРезультат;
	
КонецФункции

Функция СоздатьМассивКолонокДинамикиВалют()
	
	масРезультат = Новый Массив; 
	
	масРезультат.Добавить("ID");
	масРезультат.Добавить("Nominal");
	масРезультат.Добавить("Value");
	масРезультат.Добавить("Date");
	масРезультат.Добавить("VunitRate");
	
	Возврат масРезультат;
	
КонецФункции

Функция СоздатьМассивКолонокОстатковСредствКредитныхОрганизаций()
	
	масРезультат = Новый Массив; 
	
	масРезультат.Добавить("Date");
	масРезультат.Добавить("InRussia");
	масРезультат.Добавить("InMoscow");
	
	Возврат масРезультат;
	
КонецФункции

Функция СоздатьМассивКолонокКотировокДрагценныхМеталлов()
	
	масРезультат = Новый Массив; 
	
	масРезультат.Добавить("Date");
	масРезультат.Добавить("Code");
	масРезультат.Добавить("Buy");
	масРезультат.Добавить("Sell");
	
	Возврат масРезультат;
	
КонецФункции

Функция СоздатьМассивКолонокДинамикиСтавокМежбанковскогоРынка()
	
	масРезультат = Новый Массив; 
	
	масРезультат.Добавить("C1");
	масРезультат.Добавить("C7");
	масРезультат.Добавить("C30");
	масРезультат.Добавить("C90");
	масРезультат.Добавить("C180");
	масРезультат.Добавить("C360");
	
	Возврат масРезультат;
	
КонецФункции

Функция СоздатьМассивКолонокДинамикиСтавокПривлеченияСредств()
	
	масРезультат = Новый Массив; 
	
	масРезультат.Добавить("Overnight");
	масРезультат.Добавить("Tomnext");
	масРезультат.Добавить("Spotnext");
	масРезультат.Добавить("P1week");
	масРезультат.Добавить("Spotweek");
	масРезультат.Добавить("P2weeks");
	масРезультат.Добавить("Spot2weeks");
	масРезультат.Добавить("P1month");
	масРезультат.Добавить("P3month");
	
	Возврат масРезультат;
	
КонецФункции

Функция СоздатьМассивКолонокНовостей()
	
	масРезультат = Новый Массив; 
	
	масРезультат.Добавить("Date");
	масРезультат.Добавить("Url");
	масРезультат.Добавить("Title");
	
	Возврат масРезультат;
	
КонецФункции

Функция СоздатьМассивКолонокСоответствияBic()
	
	масРезультат = Новый Массив; 
	
	масРезультат.Добавить("Date");
	масРезультат.Добавить("Url");
	масРезультат.Добавить("Title");
	
	Возврат масРезультат;
	
КонецФункции

Функция СоздатьМассивКолонокДинамикиСтавокВалютныйСвоп()
	
	масРезультат = Новый Массив; 
		
	масРезультат.Добавить("DateBuy");
	масРезультат.Добавить("DateSell");
	масРезультат.Добавить("BaseRate");
	масРезультат.Добавить("SD");
	масРезультат.Добавить("TIR");
	масРезультат.Добавить("DEADLINEBS");
	
	Возврат масРезультат;
	
КонецФункции

Функция СоздатьМассивКолонокобКонтейнерДинамикиЦенНаИнвестиционныеМонеты() 
		
	масРезультат = Новый Массив; 
	
	масРезультат.Добавить("Date");
	масРезультат.Добавить("Price");
	масРезультат.Добавить("Nominal");
	масРезультат.Добавить("Metall");
	масРезультат.Добавить("Q");
	
	Возврат масРезультат;
	
КонецФункции
 
Функция СоздатьМассивКолонокНелегальныеОрганизации()
	
	масРезультат = Новый Массив; 
	
	масРезультат.Добавить("NAME");
	масРезультат.Добавить("INN");
	масРезультат.Добавить("Site");
	масРезультат.Добавить("Sign");
	масРезультат.Добавить("Closed");
	масРезультат.Добавить("DT");
	масРезультат.Добавить("ADDR");
	
	Возврат масРезультат;
	
КонецФункции


Функция ЗаписатьСписокXdtoВТаблицу(аргXdtoОбъект, аргМасКолонок)
	
	ТабЗначРезультат = Новый ТаблицаЗначений; 
	
	Для Каждого элНазвание Из аргМасКолонок Цикл		
		ТабЗначРезультат.Колонки.Добавить(элНазвание)		
	КонецЦикла;
	
	Для Каждого элемент Из аргXdtoОбъект Цикл
		ЗаполнитьЗначенияСвойств(ТабЗначРезультат.Добавить(), элемент);
	КонецЦикла;
	
	Возврат ТабЗначРезультат;
	
КонецФункции

	
	
	


